\section{Bad Patterns in Images of Interpretations}
\label{sec:bad-patterns}

\maelin{Commentaire général sur la section, j'ai vraiment du mal à bien saisir ce qu'est la notion de bough. J'ai laissé des commentaires là où ça me posait des problème, mais de manière générale il faudrait réussir à mieux introduire l'objet, à expliquer ce qu'il est.}

In this section, we will isolate combinatorial obstructions to being
\kl{$2$-well-quasi-ordered} in classes of graphs that are images of \kl{simple
MSO interpretations} from trees. We will take the same notations as in
\cref{sec:ramseyan}. 


% use a large two column figure here to illustrate the various notions
% we are using sigcomp latex class in two columns where the command
% \begin{figure*} ... \end{figure*} creates a figure spanning both columns
\begin{figure*}[ht]
    \centering
    \begin{tikzpicture}[
        localType/.style={
            color=C3,
            thick
        },
        branchProj/.style = {
            color=Prune,
            inner sep=0pt,
            minimum size=4pt,
            fill,
            circle
        },
        leaf/.style={
            color=Prune,
        },
        ]
        \draw (0,0) rectangle (8,2);
        \node (root) at (-3.2,2) {$\treeRoot$};
        \foreach \x in {0,1,2,3,4} {
            \coordinate (n\x) at ({ 2 * \x},0);
            \coordinate (pb\x) at ({ 2 * \x},2);
            \node[branchProj] (b\x) at (pb\x) {};
            \node (lb\x) at ({ 2 * \x},2.4) {$b_{\x}$};
            \draw (n\x) -- (b\x);
        }
        \draw[dashed,<-] (b0) -- (root);
        \draw[dashed] (b4) -- (9,2.5);
        \draw[dashed] (b4) -- (9,1.5);

        \foreach[count=\x] \y in {0,1,2,3} {
            \node (E\x) at ({ 2 * \x - 1},2.6) {$e_{\y}$};
            \draw[->,thick] (b\y) to[bend left=40] (b\x);
            \node (T\x) at ({ 2 * \x - 1},-0.6) {$\BBlock[\t]{b_{\y}}{b_{\x}}$};
        }
        
        \node (x) at (3,0.2)  {$x$};
        \node (y) at (7,0.2)  {$y$};
        \node[branchProj] (tx) at (3,2) {};
        \node[branchProj] (ty) at (7,2) {};

        \draw[localType, <-] (x)  -- 
        node[midway, left] {$\BtL(x)$} (tx);
        (tx);
        \draw[localType, ->] (tx) -- 
        node[midway, below] {$\BrL(x)$}
        (b2);
        \draw[localType, <-] (tx) -- 
        node[midway, below] {$\BlL(x)$}
        (b1);

        \draw[localType, <-] (y)  -- 
        node[midway, left] {$\BtL(y)$} 
        (ty);
        \draw[localType, ->] (ty) -- 
        node[midway, below] {$\BrL(y)$}
        (b4);
        \draw[localType, <-] (ty) --
        node[midway, below] {$\BlL(y)$}
        (b3);

        \draw[dashed] (9,2.5) -- (10,2.1) -- (10,2.9) -- cycle;
        \draw[dashed] (9,1.5) -- (10,1.1) -- (10,1.9) -- cycle;

        % now draw similar dashed triangles on the path from the root to b0
        \draw[dashed] (-2,2) -- (-2,1.5);
        \draw[dashed] (-2,1.5) -- (-1.7,1) -- (-2.3,1) -- cycle;
        \draw[dashed] (-1,2) -- (-1,1.5);
        \draw[dashed] (-1,1.5) -- (-0.7,1) -- (-1.3,1) -- cycle;

    \end{tikzpicture}
    \caption{Partitionning a branch of a tree $\aTree$ using a \kl{bough} $B$.
    Here, the nodes $b_i$ for $0 \leq i \leq 4$ are \kl{$k$-neighbours},
    and $e_i$ for the \kl{idempotent} monoid element 
    $\tlbl{\aTree}{b_i}{b_{i+1}}$. In dashed, we represented the
    \kl{context} $C[\square]$ such that $\t = C[B]$.
    To compute
    the presence of an edge between $x$ and $y$ in the resulting graph, 
    it is sufficient to know the values of
    $\tlbl{\t}{b_2}{b_3}$, and the respective \kl{bough types} of $x$ and $y$.}
    \label{partitionning-a-graph:fig}
\end{figure*}

\begin{definition}
    \label{ramseyan-branch:def}
    Let $\aTree$ be a tree and $\spt$ be a \kl{forward Ramseyan split} of height $N$.
    A \intro{bough of level $k$} in $\aTree$ is defined from a part of a $k$-neighbourhood as follows:
    Consider a sequence $b_0, b_1, \ldots, b_n$ of nodes of level $k$ on a branch of $\aTree$
    forming a \kl{$k$-neighbourhood}.
    Elements of the \reintro{bough} $B$ are all nodes $x$ in $\aTree$ such that 
    $b_0 \treeleq x$, and $\neg (b_n \treeleq x)$, plus $b_n$ itself.
    
    We say that the \intro(bough){dimension} of the \kl{bough} $B$ is $n+1$.
\end{definition}

\AP Let $B$ be a \kl{bough of level $k$} in $\aTree$.
Given two nodes $b_1 \treelt b_2$ in $B$ such that $\spt(b_1) = \spt(b_2) = k$, we define the $\BBlock[\aTree]{b_1}{b_2}$
as the set of nodes $x$ in $\aTree$ such that $b_1 \treeleq x$ and $\neg (b_2
\treeleq x)$. We also refer to
\cref{partitionning-a-graph:fig} for an illustration of the resulting partition
of the tree $\aTree$ with respect to a given \kl{bough} $B$.

\AP
For every leaf $x \in \BBlock[\aTree]{b_0}{b_n}$ where $n$ is the
\kl{dimension of the bough} $B$, we define $\intro*\Bt(x)$ to be the least ancestor of
$x$ that belongs to $B$. Similarly, we define $\intro*\Bl(x)$ to be the least element
of $B$ that is greater or equal to $\intro*\Bt(x)$, and $\intro*\Br(x)$ to be the greatest
element of $B$ that is less or equal to $\intro*\Bt(x)$. To every leaf $x$ of $B(\aTree)$,
we can therefore associate the following values in $M$:
\begin{align*}
  \intro*\BtL(x) &\defined \tlbl{\t}{\Bt(x)}{x}, \\
  \intro*\BlL(x) &\defined \tlbl{\aTree}{\Bl(x)}{\Bt(x)}, \\
  \intro*\BrL(x) &\defined \tlbl{\t}{\Bt(x)}{\Br(x)}, \\
  \intro*\BrootL(x) &\defined \tlbl{\aTree}{\treeRoot}{\Bl(x)}.
\end{align*}
We call this tuple 
the \intro{bough type} of the leaf $x$ with respect to the \kl{bough} $B$.
We again refer to 
\cref{partitionning-a-graph:fig}
for an illustration of the type of a leaf
with respect to a given \kl{bough} $B$. There are only finitely 
many possible \kl{bough types} because $M$ is finite.


\AP In the rest of the paper, we will ofter rely on some tree surgery operation
consisting in replacing a \kl{bough} in a tree by some other \kl{bough}. Given
a \kl{bough} $B$ in a tree $\t$ defined using a \kl{$k$-neighbourhood}
$b_0$, $b_1$, \ldots, $b_n$,
we write $\t = C[B]$ to denote that $\t$ can
be obtained by plugging the \kl{bough} $B$ into a \intro(bough){context} $C[\square]$.
Formally, a \reintro(bough){context} $C[\square]$ is given by a tree $\t_{\mathsf{root}}$
with a distinguished leaf $\square$, together with two trees
$\t_{\mathsf{left}}$ and $\t_{\mathsf{right}}$. These three elements are
reprenented as dashed lines in \cref{partitionning-a-graph:fig}.
The tree $C[B]$ is then obtained as follows: one first attaches 
$\t_{\mathsf{left}}$ as the left subtree of $b_n$,
where $b_n$ is the last element of the \kl{$k$-neighbourhood} defining $B$,
then one attaches $\t_{\mathsf{right}}$ as the right subtree of $b_n$, and finally,
one replaces the distinguished leaf $\square$ in $\t_{\mathsf{root}}$ by the
node $b_0$, the first element of the \kl{$k$-neighbourhood} defining $B$.

\AP Two boughs $B$ and $B'$ are \intro{compatible} if they start with the same
idempotent value, and if for every tree $\aTree = C[B]$, the tree $C[B']$ is
also well-defined (i.e., it remains \kl{forward Ramseyan}). The following
\cref{fact:bough-replacement} states that one can safely perform such a
replacement without modifying the part of the graph represented by the tree
$\t$ outside of the \kl{bough}.

\maelin{Je suis confus sur ce qu'est un bough, c'est une chemin ? un sous-arbre ? la façon dont tu le défini pour moi c'est simplement un chemin, sauf que j'ai l'impression que ça devrait être un arbre (genre un chemin avec des sous-arbre pendant).}

\begin{fact}
  \label{fact:bough-replacement}
  Let $\t = C[B]$ be a tree with a \kl{bough} $B$ of level $k$, 
  and let $H$ be a \kl{bough} that is \kl{compatible}
  with $B$. Let $\t' = C[H]$ be the tree obtained by replacing $B$ by $H$ in $\t$.
  Then, the subraph of $\someInterp(\t)$ induced by the leaves 
  outside of $B$ is isomorphic (using the identity map) 
  to the subgraph of $\someInterp(\t')$
  induced by the leaves outside of $H$.
\end{fact}



\begin{definition}
    \label{good-bough:def}
    Let $B$ be a \kl{bough} of level $k$ in a tree $\t$.
    We say that $B$ is a \intro{good bough} if, 
    there exists a \kl{compatible} \kl{bough} $H$ of level $k$,
    and a map $h \colon \someInterp(C[B]) \to \someInterp(C[H])$
    such that:
    \begin{enumerate}
        \item $h$ is an embedding of graphs,
        \item $h$ is the identity map on leaves belonging $C[\square]$,
        \item there exists a \kl{block} in $H$ that is left untouched 
          by $h$.
    \end{enumerate}
    A \intro{bad bough} is a \kl{bough} that is not a \kl{good bough}.
\end{definition}

We claim that the existence of \kl{bad boughs} of arbitrarily large
\kl{dimension} is the only obstruction to being \kl{2-well-quasi-ordered}.

\begin{lemma}
  \label{lem:good-boughs-wqo}
  The image of $\someInterp$ is \kl{$2$-well-quasi-ordered} 
  if and only if
  the image of $\someInterp$ is \kl{$\forall$-well-quasi-ordered} 
  if and only if 
  there exists a bound on the \kl{dimension} of \kl{bad boughs}.
\end{lemma}

The proof of \cref{lem:good-boughs-wqo} is split into two parts, one will
leverage the bound on the \kl{dimension} of \kl{bad boughs} to construct a
suitable tree representation of the graphs proving that they are
\kl{$\forall$-well-quasi-ordering} (\cref{sec:gap-embedding}). On the other
hand, we will show that the existence of \kl{bad boughs} of arbitrarily large
\kl{dimension} allows to construct an infinite two-labelled antichain in the
image of $\someInterp$ (\cref{sec:obstructions}).


\subsection{Using the Gap Embedding}
\label{sec:gap-embedding}

\AP If there is an upper bound $N_0$ on the \kl{dimension} of \kl{bad boughs}, we can
use \cref{fact:bough-replacement} to upgrade our trees in the following way:
given a tree $\t$, we will insert dummy nodes in every \kl{bough} of level $k$
that has \kl{dimension} greater than $N_0$. The resulting tree $\t'$ will be a
\kl{marked nested tree} as defined in \cref{sec:ramseyan}, with three
kinds of nodes: \kl{marked nodes}, that correspond to nodes of $\t$,
\kl{dummy nodes} that were inserted during this procedure,
and \kl{separating nodes}, that are the last nodes of the \kl{$k$-neighbourhoods}
defining the \kl{boughs} we manipulated.
The following 
\cref{lem:important-nodes} shows that this construction produces
\kl{well-marked nested trees} that are \kl{$N_0$-bounded}, allowing us to apply
\cref{thm:marked-nested-trees-wqo}.

\begin{lemma}
    \label{lem:important-nodes}
    Assume that there exists a bound $N_0$ on the \kl{dimension} of \kl{bad
    boughs}. Then, for every tree $\t$ equipped with a \kl{forward Ramseyan split} $\spt$, 
    one can effectively construct a \kl{well-marked nested tree} $(\t', \spt', \marking)$ 
    that is \kl{$N_0$-bounded} and such that
    the restriction of $\someInterp(\t')$ to \kl{marked leaves}
    is isomorphic to $\someInterp(\t)$.
\end{lemma}
\begin{proof}
  We proceed top-down in the tree $\t$. At the beginning, we define 
  every node of $\t$ as \kl(nodes){marked}.

  Whenever we encounter a \kl{bough} $B$ of level $k$ with dimension greater
  than $N_0$, we first consider its prefix of \kl{dimension} $N_0 + 1$. 
  This prefix is a \kl{good bough} by assumption on the bound $N_0$,
  hence there exists a \kl{compatible} \kl{bough} $H$ of level $k$
  and one can replace $B$ by $H$ in $\t$. This operation does not 
  modify the graph outside of the \kl{bough} by \cref{fact:bough-replacement}.
  Furthermore, by definition of \kl{good boughs}, the graph induced 
  by $B$ is an induced subgraph of the graph induced by $H$.
  We update the marking accordingly so that leaves of $B$ that were marked 
  remain marked in $H$, untouched leaves of $H$ become \kl{dummy},
  and we mark the last element of the $k$-neighbourhood defining $H$
  as a \kl{separating node}.
  Then, we complete
  the marking by ensuring that the least common ancestor
  of two \kl{marked nodes} is also \kl{marked}. By definition, the graph
  induced by the \kl{marked leaves} remains unchanged by this operation.
  
  To verify that $(\t', \spt', \marking)$ is \kl{well-marked}, note that by construction,
  whenever we have \kl{marked nodes} $x$ and $y$ with a non-\kl{marked} node in between
  at level $k$, this configuration arises from a \kl{bough} replacement where
  the required witnesses $z_1, z_2, z_3$ exist by the definition of \kl{good boughs}.
  Moreover, the tree is \kl{$N_0$-bounded} because every maximal path of non-\kl{dummy}
  nodes has length at most $N_0$ by a simple induction on the length.
\end{proof}

\AP By \cref{lem:important-nodes}, we can transform any tree into a \kl{$N_0$-bounded}
\kl{well-marked nested tree}. By \cref{thm:marked-nested-trees-wqo}, the class of
such trees is \kl{well-quasi-ordered} under the \kl{gap-embedding} ordering. Furthermore,
by \cref{cor:gap-embedding-monotone}, the \kl{gap-embedding} ordering between
\kl{marked nested trees} preserves the interpretation: if $(\t_1, \spt_1, \marking_1)
\gemb (\t_2, \spt_2, \marking_2)$, then the graph interpreted from
$(\t_1, \spt_1, \marking_1)$ (restricted to \kl{marked leaves}) is an induced
subgraph of the graph interpreted from $(\t_2, \spt_2, \marking_2)$ (restricted to
\kl{marked leaves}). Since the interpretation restricted to \kl{marked leaves}
coincides with the original interpretation on $\t_1$ and $\t_2$ by \cref{lem:important-nodes},
this establishes the desired order-preserving property.

\subsection{Obstructions}
\label{sec:obstructions}

\AP In this section, we will assume that there 
exist \kl{bad boughs} of arbitrarily large \kl{dimension}, and we will
leverage this to construct an infinite \kl{antichain} in the image of
$\someInterp$.

Our first remark is that there are only finitely many equivalence 
classes for \kl{boughs} of a given level $k$ with respect to \kl{compatibility}.
This is the content of the following \cref{lem:finitely-many-boughs}.


\begin{lemma}
  \label{lem:finitely-many-boughs}
  Let $k$ be a level. There exists a finite set of \kl{boughs} of level $k$
  such that every \kl{bough} of level $k$ is \kl{compatible} with one of them.
\end{lemma}
\begin{proof}
  Sketch: Compatibility between two \kl{boughs} $B$ and $B'$ of level $k$ 
  is determined by the shape of the beginning and ends of the splits of $B$ and $B'$,
  and there are finitely many such shapes.
\end{proof}

\begin{lemma}
  \label{lem:finitely-many-contexts}
  There exists a finite set $\mathcal{F}$ of contexts $C[\square]$ such that
  for every bad bough $B$ of level $k$, there exists a context
  $C[\square] \in \mathcal{F}$ such that $B$ is a \kl{bad bough} in $C[B]$.
\end{lemma}
\begin{proof}
  Sketch: the context is not very important in good boughs
  because outside it is the identity map. Furthermore, the behaviour
  of nodes in the context with respect to those of the bough 
  is determined by a finite number of monoid elements.
  Hence, if a bough is good in some context, it is good in any context with 
  the same behaviour and there are finitely many such contexts.
\end{proof}


\begin{lemma}
  \label{lem:bad-bough-antichain}
  If there exist \kl{bad boughs} of arbitrarily large \kl{dimension},
  then there exists an infinite two-colored \kl{antichain} in the image of $\someInterp$.
\end{lemma}
\begin{proof}
  Assume towards a contradiction that the class of graphs 
  obtained as images of $\someInterp$ is \kl{$2$-well-quasi-ordered}.
  Let $\seqof{B_i}[i \geq 1]$ be an infinite sequence of \kl{bad boughs}. Without loss 
  of generality, one can assume that all \kl{boughs} $B_i$ have the same level $k$,
  and are pairwise \kl{compatible}, by \cref{lem:finitely-many-boughs}.

  Now, using \cref{lem:finitely-many-contexts}, one can extract one context 
  $C[\square]$ such that infinitely many \kl{boughs} $B_i$ are \kl{bad boughs}
  in $C[B_i]$. Finally, one can extract further to assume that 
  the \kl{dimension} of the \kl{boughs} $B_{i+1}$ 
  is greater than twice the number of leaves in $B_i$.

  Let us now color every graph $\someInterp(C[B_i])$ with two labels: $\top$
  to leaves belonging to $B_i$, and color $\bot$ to leaves belonging to
  $C[\square]$. Because we assume that the image of $\someInterp$ is
  \kl{$2$-well-quasi-ordered}, we can extract an infinite increasing
  subsequence, and assume that for all $i < j$, there exists an embedding $f_{i,j}
  \colon \someInterp(C[B_i]) \to \someInterp(C[B_j])$ that preserves labels.
  Let us remark that for all $i < j$, the map 
  $f_{i,j}$ acts as a permutation when restricted to nodes labelled $\bot$,
  that is of size the number of leaves in $C[\square]$.
  By a Ramsey argument, we can therefore assume that this permutation is the identity
  for all $i < j$.
  Finally, consider any two indices $i < j$. 

  Because the \kl{dimension} of $B_j$ is greater than twice the number of leaves
  in $B_i$, there must be some \kl{block} in $B_j$ that is left untouched by $f_{i,j}$.
  Furthermore, we know that $f_{i,j}$ is the identity on leaves
  belonging to $C[\square]$. Hence, the map $f_{i,j}$
  witnesses that $B_i$ is a \kl{good bough} in $C[B_i]$, which is a contradiction.
\end{proof}

